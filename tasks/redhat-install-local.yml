---
# $Author$
# $Date$
# $Source$

- name: Remove agent repo keys if they exist
  rpm_key:
    key: https://download.newrelic.com/infrastructure_agent/gpg/newrelic-infra.gpg
    state: absent

- name: Remove agent repo reference
  yum_repository:
    name: 'newrelic-infra'
    state: absent
#  register: setup_agent_repo
  notify: yum-clean-metadata

- name: Remove agent repo keys
  rpm_key:
    key: https://download.newrelic.com/infrastructure_agent/gpg/newrelic-infra.gpg
    state: absent

- name: Clear the list of the newrelic-infra agent packages required
  set_fact:
    newrelic_infra_sources: "[]"

- name: Create a list of the newrelic-infra agent packages required
  set_fact:
    newrelic_infra_sources: "{{ newrelic_infra_sources | default([]) }} + [ '{{ item.name }}-{{ item.version }}-{{ item.release }}.{{ ansible_architecture }}.rpm' ]"
  with_items:  "{{ newrelic_infra_packages }}"

- name: Display the newrelic-infra agent packages to be installed
  debug:
    var: newrelic_infra_sources
    verbosity: 2

- name: Copy newrelic-infra agent packages to the host
  copy:
    src:      "{{ newrelic_infra_agent_source }}/el{{ ansible_distribution_major_version }}/{{ item }}"    
    dest:     "/tmp/{{ item }}"
    owner:    root
    group:    root
    mode:     '0600'
  with_items: "{{ newrelic_infra_sources }}"
  check_mode: false

- name: Install the newrelic-infra agent packages.
  yum:
    name:     "/tmp/{{ item }}"
    state:    present
  with_items: "{{ newrelic_infra_sources }}"
  notify:     Restart newrelic-infra

- name: Remove the temporary newrelic-infra packages used for the install
  file:
    name:     "/tmp/{{ item }}"
    state:    absent
  with_items: "{{ newrelic_infra_sources }}"
  check_mode: false
  